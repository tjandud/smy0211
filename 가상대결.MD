# ê°€ìƒ ëŒ€ê²° ì‹œìŠ¤í…œ êµ¬í˜„ ê³„íšì„œ

## ëª©ì°¨
1. [ê°œìš”](#1-ê°œìš”)
2. [ê°€ìƒ ê²½ìŸì AI](#2-ê°€ìƒ-ê²½ìŸì-ai)
3. [ì¹œêµ¬ ëŒ€ê²° ëª¨ë“œ](#3-ì¹œêµ¬-ëŒ€ê²°-ëª¨ë“œ)
4. [ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ](#4-ë°ì´í„°ë² ì´ìŠ¤-ìŠ¤í‚¤ë§ˆ)
5. [êµ¬í˜„ ìš°ì„ ìˆœìœ„](#5-êµ¬í˜„-ìš°ì„ ìˆœìœ„)

---

## 1. ê°œìš”

### 1.1 ëª©ì 
- ì‚¬ìš©ìì˜ í‹°ì¼“íŒ… ì—°ìŠµì— ê²½ìŸ ìš”ì†Œë¥¼ ì¶”ê°€í•˜ì—¬ ëª°ì…ë„ í–¥ìƒ
- ì‹¤ì œ ëŒ€ê²° í™˜ê²½ê³¼ ìœ ì‚¬í•œ ê¸´ì¥ê° ì œê³µ
- ì‚¬ìš©ì ê°„ ìƒí˜¸ì‘ìš©ì„ í†µí•œ ì»¤ë®¤ë‹ˆí‹° í™œì„±í™”

### 1.2 ë‘ ê°€ì§€ ëª¨ë“œ
| ëª¨ë“œ | ì„¤ëª… | ë„¤íŠ¸ì›Œí¬ | ë³µì¡ë„ |
|------|------|----------|--------|
| ê°€ìƒ ê²½ìŸì AI | í´ë¼ì´ì–¸íŠ¸ ì¸¡ AI ì‹œë®¬ë ˆì´ì…˜ | ë¶ˆí•„ìš” | ë‚®ìŒ |
| ì¹œêµ¬ ëŒ€ê²° | Supabase Realtime ì‹¤ì‹œê°„ ë™ê¸°í™” | í•„ìš” | ë†’ìŒ |

---

## 2. ê°€ìƒ ê²½ìŸì AI

### 2.1 ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    í´ë¼ì´ì–¸íŠ¸ (ë¸Œë¼ìš°ì €)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   ì‚¬ìš©ì     â”‚    â”‚   AI ì—”ì§„   â”‚    â”‚   UI ë Œë”ëŸ¬  â”‚  â”‚
â”‚  â”‚   ì…ë ¥ ì²˜ë¦¬  â”‚â”€â”€â”€â–¶â”‚  (ì‹œë®¬ë ˆì´ì…˜) â”‚â”€â”€â”€â–¶â”‚  (ì§„í–‰ í‘œì‹œ) â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                  â”‚                  â”‚         â”‚
â”‚         â–¼                  â–¼                  â–¼         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              ê²Œì„ ìƒíƒœ ê´€ë¦¬ì                     â”‚   â”‚
â”‚  â”‚  - ì‚¬ìš©ì ì§„í–‰ë¥   - AI ì§„í–‰ë¥   - íƒ€ì´ë¨¸          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 AI í”„ë¡œí•„ ì •ì˜

```javascript
// js/ai-profiles.js

const AI_PROFILES = {
    // ì´ˆë³´ì AI - ëŠë¦¬ê³  ì‹¤ìˆ˜ ë§ìŒ
    beginner: {
        name: 'í‹°ì¼“íŒ… ìƒˆë‚´ê¸°',
        avatar: 'ğŸ£',
        description: 'ì²˜ìŒ í‹°ì¼“íŒ…ì„ ë°°ìš°ëŠ” ì¤‘ì´ì—ìš”',
        baseSpeed: 3000,        // ê¸°ë³¸ í´ë¦­ ê°„ê²© (ms)
        speedVariance: 1500,    // ì†ë„ ë³€ë™í­
        errorRate: 0.15,        // 15% ì‹¤ìˆ˜ í™•ë¥ 
        recoveryTime: 2000,     // ì‹¤ìˆ˜ í›„ ë³µêµ¬ ì‹œê°„
        difficulty: 'easy'
    },

    // ì¼ë°˜ ì‚¬ìš©ì AI
    casual: {
        name: 'ì£¼ë§ í‹°ì¼“ëŸ¬',
        avatar: 'ğŸ˜Š',
        description: 'ê°€ë” í‹°ì¼“íŒ…í•˜ëŠ” ì¼ë°˜ì¸',
        baseSpeed: 1500,
        speedVariance: 800,
        errorRate: 0.08,
        recoveryTime: 1500,
        difficulty: 'normal'
    },

    // ìˆ™ë ¨ì AI
    experienced: {
        name: 'ì½˜ì„œíŠ¸ ë§ˆë‹ˆì•„',
        avatar: 'ğŸ¸',
        description: 'ìˆ˜ì‹­ ë²ˆì˜ í‹°ì¼“íŒ… ê²½í—˜ì',
        baseSpeed: 800,
        speedVariance: 400,
        errorRate: 0.03,
        recoveryTime: 800,
        difficulty: 'normal'
    },

    // í”„ë¡œ AI
    pro: {
        name: 'í‹°ì¼“íŒ… ê³ ìˆ˜',
        avatar: 'âš¡',
        description: 'ì‹¤íŒ¨ë¥¼ ëª¨ë¥´ëŠ” í”„ë¡œ',
        baseSpeed: 400,
        speedVariance: 200,
        errorRate: 0.01,
        recoveryTime: 500,
        difficulty: 'hard'
    },

    // ì „ì„¤ AI
    legend: {
        name: 'ì „ì„¤ì˜ í‹°ì¼“ëŸ¬',
        avatar: 'ğŸ‘‘',
        description: '0.1ì´ˆ ì»·ì„ ì„±ê³µì‹œí‚¨ ì „ì„¤',
        baseSpeed: 200,
        speedVariance: 100,
        errorRate: 0.005,
        recoveryTime: 300,
        difficulty: 'hard'
    }
};
```

### 2.3 AI ì‹œë®¬ë ˆì´ì…˜ ì—”ì§„

```javascript
// js/ai-simulator.js

class AISimulator {
    constructor(profile) {
        this.profile = AI_PROFILES[profile];
        this.progress = 0;           // 0-100%
        this.currentStep = 0;
        this.totalSteps = 0;
        this.isFinished = false;
        this.startTime = null;
        this.finishTime = null;
        this.errors = 0;
    }

    // AI ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘
    start(totalSteps) {
        this.totalSteps = totalSteps;
        this.startTime = Date.now();
        this.simulateNextStep();
    }

    // ë‹¤ìŒ ë‹¨ê³„ ì‹œë®¬ë ˆì´ì…˜
    simulateNextStep() {
        if (this.isFinished) return;

        // ì‹¤ìˆ˜ ì²´í¬
        if (Math.random() < this.profile.errorRate) {
            this.handleError();
            return;
        }

        // ë‹¤ìŒ í´ë¦­ê¹Œì§€ ì†Œìš” ì‹œê°„ ê³„ì‚°
        const delay = this.calculateDelay();

        setTimeout(() => {
            this.currentStep++;
            this.progress = (this.currentStep / this.totalSteps) * 100;

            // ì§„í–‰ ìƒí™© ì´ë²¤íŠ¸ ë°œìƒ
            this.onProgress(this.progress, this.currentStep);

            if (this.currentStep >= this.totalSteps) {
                this.finish();
            } else {
                this.simulateNextStep();
            }
        }, delay);
    }

    // í´ë¦­ ë”œë ˆì´ ê³„ì‚° (ë³€ë™ì„± í¬í•¨)
    calculateDelay() {
        const variance = (Math.random() - 0.5) * 2 * this.profile.speedVariance;
        return Math.max(100, this.profile.baseSpeed + variance);
    }

    // ì‹¤ìˆ˜ ì²˜ë¦¬
    handleError() {
        this.errors++;
        this.onError(this.errors);

        setTimeout(() => {
            this.simulateNextStep();
        }, this.profile.recoveryTime);
    }

    // ì™„ë£Œ ì²˜ë¦¬
    finish() {
        this.isFinished = true;
        this.finishTime = Date.now();
        const elapsedTime = this.finishTime - this.startTime;
        this.onFinish(elapsedTime, this.errors);
    }

    // ì´ë²¤íŠ¸ ì½œë°± (ì˜¤ë²„ë¼ì´ë“œ ê°€ëŠ¥)
    onProgress(progress, step) {}
    onError(errorCount) {}
    onFinish(elapsedTime, errors) {}

    // AI ì¤‘ì§€
    stop() {
        this.isFinished = true;
    }
}
```

### 2.4 ëŒ€ê²° UI ì»´í¬ë„ŒíŠ¸

```html
<!-- ëŒ€ê²° í™”ë©´ UI -->
<div class="battle-container">
    <!-- ìƒë‹¨: ëŒ€ê²° ì •ë³´ -->
    <div class="battle-header">
        <div class="battle-title">ğŸ¯ ê°€ìƒ ëŒ€ê²° ëª¨ë“œ</div>
        <div class="battle-timer" id="battleTimer">00:00.00</div>
    </div>

    <!-- ì¤‘ì•™: ì§„í–‰ ìƒí™© ë¹„êµ -->
    <div class="battle-progress">
        <!-- ì‚¬ìš©ì -->
        <div class="player-card user">
            <div class="player-avatar">ğŸ˜</div>
            <div class="player-name" id="userName">ë‚˜</div>
            <div class="progress-bar">
                <div class="progress-fill user-progress" id="userProgress"></div>
            </div>
            <div class="player-step">
                <span id="userStep">0</span> / <span id="totalSteps">5</span>
            </div>
        </div>

        <!-- VS -->
        <div class="vs-badge">VS</div>

        <!-- AI -->
        <div class="player-card ai">
            <div class="player-avatar" id="aiAvatar">ğŸ¤–</div>
            <div class="player-name" id="aiName">AI ìƒëŒ€</div>
            <div class="progress-bar">
                <div class="progress-fill ai-progress" id="aiProgress"></div>
            </div>
            <div class="player-step">
                <span id="aiStep">0</span> / <span id="totalSteps2">5</span>
            </div>
        </div>
    </div>

    <!-- í•˜ë‹¨: ê²Œì„ ì˜ì—­ -->
    <div class="game-area" id="gameArea">
        <!-- ê¸°ì¡´ í‹°ì¼“íŒ… ê²Œì„ ì»´í¬ë„ŒíŠ¸ -->
    </div>
</div>
```

### 2.5 ëŒ€ê²° ìŠ¤íƒ€ì¼

```css
/* css/battle.css */

.battle-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
}

.battle-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    background: linear-gradient(135deg, #1e1e2e 0%, #2d2d44 100%);
    border-radius: 12px;
    margin-bottom: 20px;
}

.battle-title {
    font-size: 1.5rem;
    font-weight: bold;
    color: #fff;
}

.battle-timer {
    font-size: 2rem;
    font-family: 'Courier New', monospace;
    color: #ffd700;
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
}

.battle-progress {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 20px;
    margin-bottom: 30px;
}

.player-card {
    flex: 1;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 16px;
    padding: 20px;
    text-align: center;
    border: 2px solid transparent;
    transition: all 0.3s ease;
}

.player-card.user {
    border-color: rgba(59, 130, 246, 0.5);
}

.player-card.ai {
    border-color: rgba(239, 68, 68, 0.5);
}

.player-card.winning {
    transform: scale(1.02);
    box-shadow: 0 0 20px rgba(34, 197, 94, 0.4);
}

.player-avatar {
    font-size: 3rem;
    margin-bottom: 10px;
}

.player-name {
    font-size: 1.2rem;
    font-weight: bold;
    color: #fff;
    margin-bottom: 15px;
}

.progress-bar {
    height: 12px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 6px;
    overflow: hidden;
    margin-bottom: 10px;
}

.progress-fill {
    height: 100%;
    border-radius: 6px;
    transition: width 0.3s ease;
}

.progress-fill.user-progress {
    background: linear-gradient(90deg, #3b82f6, #60a5fa);
}

.progress-fill.ai-progress {
    background: linear-gradient(90deg, #ef4444, #f87171);
}

.vs-badge {
    font-size: 2rem;
    font-weight: bold;
    color: #ffd700;
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    padding: 10px 20px;
    background: rgba(255, 215, 0, 0.1);
    border-radius: 50%;
}

/* ìŠ¹ë¦¬/íŒ¨ë°° ì• ë‹ˆë©”ì´ì…˜ */
@keyframes winner-pulse {
    0%, 100% { box-shadow: 0 0 20px rgba(34, 197, 94, 0.4); }
    50% { box-shadow: 0 0 40px rgba(34, 197, 94, 0.8); }
}

.player-card.winner {
    border-color: #22c55e;
    animation: winner-pulse 1s ease-in-out infinite;
}

.player-card.loser {
    opacity: 0.6;
    filter: grayscale(50%);
}
```

### 2.6 ëŒ€ê²° ê´€ë¦¬ì í´ë˜ìŠ¤

```javascript
// js/battle-manager.js

class BattleManager {
    constructor(options) {
        this.gameType = options.gameType;       // 'concert', 'goods', 'restaurant'
        this.difficulty = options.difficulty;    // 'easy', 'normal', 'hard'
        this.aiProfile = options.aiProfile;      // AI í”„ë¡œí•„ í‚¤

        this.userProgress = 0;
        this.aiSimulator = null;
        this.startTime = null;
        this.isGameRunning = false;

        this.initUI();
    }

    initUI() {
        // AI ì •ë³´ í‘œì‹œ
        const profile = AI_PROFILES[this.aiProfile];
        document.getElementById('aiAvatar').textContent = profile.avatar;
        document.getElementById('aiName').textContent = profile.name;
    }

    // ëŒ€ê²° ì‹œì‘
    startBattle(totalSteps) {
        this.isGameRunning = true;
        this.startTime = Date.now();

        // íƒ€ì´ë¨¸ ì‹œì‘
        this.startTimer();

        // AI ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘
        this.aiSimulator = new AISimulator(this.aiProfile);

        this.aiSimulator.onProgress = (progress, step) => {
            this.updateAIProgress(progress, step);
        };

        this.aiSimulator.onError = (errorCount) => {
            this.showAIError();
        };

        this.aiSimulator.onFinish = (elapsedTime, errors) => {
            this.handleAIFinish(elapsedTime, errors);
        };

        this.aiSimulator.start(totalSteps);
    }

    // íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸
    startTimer() {
        this.timerInterval = setInterval(() => {
            if (!this.isGameRunning) return;

            const elapsed = Date.now() - this.startTime;
            document.getElementById('battleTimer').textContent =
                this.formatTime(elapsed);
        }, 10);
    }

    // ì‹œê°„ í¬ë§·
    formatTime(ms) {
        const minutes = Math.floor(ms / 60000);
        const seconds = Math.floor((ms % 60000) / 1000);
        const centiseconds = Math.floor((ms % 1000) / 10);

        return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(centiseconds).padStart(2, '0')}`;
    }

    // ì‚¬ìš©ì ì§„í–‰ ì—…ë°ì´íŠ¸ (ê²Œì„ì—ì„œ í˜¸ì¶œ)
    updateUserProgress(progress, step) {
        this.userProgress = progress;
        document.getElementById('userProgress').style.width = `${progress}%`;
        document.getElementById('userStep').textContent = step;

        this.checkLeading();
    }

    // AI ì§„í–‰ ì—…ë°ì´íŠ¸
    updateAIProgress(progress, step) {
        document.getElementById('aiProgress').style.width = `${progress}%`;
        document.getElementById('aiStep').textContent = step;

        this.checkLeading();
    }

    // ì„ ë‘ ì²´í¬
    checkLeading() {
        const userCard = document.querySelector('.player-card.user');
        const aiCard = document.querySelector('.player-card.ai');

        if (this.userProgress > this.aiSimulator.progress) {
            userCard.classList.add('winning');
            aiCard.classList.remove('winning');
        } else if (this.aiSimulator.progress > this.userProgress) {
            aiCard.classList.add('winning');
            userCard.classList.remove('winning');
        } else {
            userCard.classList.remove('winning');
            aiCard.classList.remove('winning');
        }
    }

    // AI ì‹¤ìˆ˜ í‘œì‹œ
    showAIError() {
        const aiCard = document.querySelector('.player-card.ai');
        aiCard.classList.add('error-shake');
        setTimeout(() => aiCard.classList.remove('error-shake'), 500);
    }

    // ì‚¬ìš©ì ì™„ë£Œ
    handleUserFinish(elapsedTime) {
        this.userFinishTime = elapsedTime;
        this.checkBattleEnd();
    }

    // AI ì™„ë£Œ
    handleAIFinish(elapsedTime, errors) {
        this.aiFinishTime = elapsedTime;
        this.aiErrors = errors;
        this.checkBattleEnd();
    }

    // ëŒ€ê²° ì¢…ë£Œ ì²´í¬
    checkBattleEnd() {
        // ë‘˜ ë‹¤ ì™„ë£Œë˜ì—ˆê±°ë‚˜, í•œ ëª…ì´ ì™„ë£Œë˜ë©´ ì¢…ë£Œ
        if (this.userFinishTime || this.aiFinishTime) {
            this.endBattle();
        }
    }

    // ëŒ€ê²° ì¢…ë£Œ
    endBattle() {
        this.isGameRunning = false;
        clearInterval(this.timerInterval);

        if (this.aiSimulator) {
            this.aiSimulator.stop();
        }

        // ê²°ê³¼ íŒì •
        const userWins = this.userFinishTime &&
            (!this.aiFinishTime || this.userFinishTime < this.aiFinishTime);

        this.showResult(userWins);
    }

    // ê²°ê³¼ í‘œì‹œ
    showResult(userWins) {
        const userCard = document.querySelector('.player-card.user');
        const aiCard = document.querySelector('.player-card.ai');

        if (userWins) {
            userCard.classList.add('winner');
            aiCard.classList.add('loser');
            this.showVictoryModal();
        } else {
            aiCard.classList.add('winner');
            userCard.classList.add('loser');
            this.showDefeatModal();
        }
    }

    // ìŠ¹ë¦¬ ëª¨ë‹¬
    showVictoryModal() {
        const timeDiff = this.aiFinishTime
            ? (this.aiFinishTime - this.userFinishTime)
            : 0;

        Swal.fire({
            title: 'ğŸ‰ ìŠ¹ë¦¬!',
            html: `
                <div style="text-align: center;">
                    <p>ì¶•í•˜í•©ë‹ˆë‹¤! AIë¥¼ ì´ê²¼ìŠµë‹ˆë‹¤!</p>
                    <p><strong>ë‚´ ê¸°ë¡:</strong> ${this.formatTime(this.userFinishTime)}</p>
                    ${this.aiFinishTime ? `<p><strong>AI ê¸°ë¡:</strong> ${this.formatTime(this.aiFinishTime)}</p>` : ''}
                    ${timeDiff > 0 ? `<p><strong>ì°¨ì´:</strong> ${this.formatTime(timeDiff)} ë¹ ë¦„</p>` : ''}
                </div>
            `,
            icon: 'success',
            confirmButtonText: 'ë‹¤ì‹œ ë„ì „',
            showCancelButton: true,
            cancelButtonText: 'í™ˆìœ¼ë¡œ'
        }).then((result) => {
            if (result.isConfirmed) {
                location.reload();
            } else {
                location.href = '../index.html';
            }
        });
    }

    // íŒ¨ë°° ëª¨ë‹¬
    showDefeatModal() {
        const profile = AI_PROFILES[this.aiProfile];

        Swal.fire({
            title: 'ğŸ˜¢ íŒ¨ë°°...',
            html: `
                <div style="text-align: center;">
                    <p>${profile.name}ì—ê²Œ ì¡ŒìŠµë‹ˆë‹¤.</p>
                    <p><strong>AI ê¸°ë¡:</strong> ${this.formatTime(this.aiFinishTime)}</p>
                    ${this.userFinishTime ? `<p><strong>ë‚´ ê¸°ë¡:</strong> ${this.formatTime(this.userFinishTime)}</p>` : '<p>ì™„ë£Œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>'}
                    <p style="margin-top: 15px; color: #888;">ë” ì—°ìŠµí•´ì„œ ë‹¤ì‹œ ë„ì „í•´ë³´ì„¸ìš”!</p>
                </div>
            `,
            icon: 'error',
            confirmButtonText: 'ë‹¤ì‹œ ë„ì „',
            showCancelButton: true,
            cancelButtonText: 'í™ˆìœ¼ë¡œ'
        }).then((result) => {
            if (result.isConfirmed) {
                location.reload();
            } else {
                location.href = '../index.html';
            }
        });
    }
}
```

---

## 3. ì¹œêµ¬ ëŒ€ê²° ëª¨ë“œ

### 3.1 ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   í”Œë ˆì´ì–´ A      â”‚         â”‚   í”Œë ˆì´ì–´ B      â”‚
â”‚   (ë¸Œë¼ìš°ì €)      â”‚         â”‚   (ë¸Œë¼ìš°ì €)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                            â”‚
         â”‚    WebSocket ì—°ê²°          â”‚
         â–¼                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Supabase Realtime                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         game_channel_{room_id}          â”‚   â”‚
â”‚  â”‚  - player_progress                      â”‚   â”‚
â”‚  â”‚  - game_state                           â”‚   â”‚
â”‚  â”‚  - chat_messages                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                            â”‚
         â–¼                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Supabase Database                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  game_rooms  â”‚    â”‚  game_participants   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 ë°ì´í„° íë¦„

```
1. ë°© ìƒì„± (í˜¸ìŠ¤íŠ¸)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     INSERT      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ í˜¸ìŠ¤íŠ¸   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ game_rooms  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ ë°© ì½”ë“œ ê³µìœ 
        â–¼
2. ë°© ì°¸ê°€ (ê²ŒìŠ¤íŠ¸)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     SELECT      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ ê²ŒìŠ¤íŠ¸   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ game_rooms  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ INSERT
        â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ game_participants   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

3. ì‹¤ì‹œê°„ ëŒ€ê²°
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  progress_update  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  broadcast  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚í”Œë ˆì´ì–´A â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚   Realtime   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚í”Œë ˆì´ì–´B â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚   Channel    â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 Supabase Realtime ì´ë²¤íŠ¸ êµ¬ì¡°

```javascript
// ì±„ë„ ì´ë²¤íŠ¸ íƒ€ì… ì •ì˜
const GAME_EVENTS = {
    // í”Œë ˆì´ì–´ ìƒíƒœ
    PLAYER_JOIN: 'player_join',          // í”Œë ˆì´ì–´ ì°¸ê°€
    PLAYER_READY: 'player_ready',        // ì¤€ë¹„ ì™„ë£Œ
    PLAYER_LEAVE: 'player_leave',        // í”Œë ˆì´ì–´ í‡´ì¥

    // ê²Œì„ ì§„í–‰
    GAME_START: 'game_start',            // ê²Œì„ ì‹œì‘
    PROGRESS_UPDATE: 'progress_update',   // ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
    STEP_COMPLETE: 'step_complete',       // ë‹¨ê³„ ì™„ë£Œ
    GAME_FINISH: 'game_finish',          // ê²Œì„ ì™„ë£Œ

    // ì±„íŒ…
    CHAT_MESSAGE: 'chat_message',        // ì±„íŒ… ë©”ì‹œì§€

    // ì‹œìŠ¤í…œ
    COUNTDOWN: 'countdown',              // ì¹´ìš´íŠ¸ë‹¤ìš´
    ERROR: 'error'                       // ì—ëŸ¬
};

// ì´ë²¤íŠ¸ í˜ì´ë¡œë“œ ì˜ˆì‹œ
const eventPayloads = {
    progress_update: {
        user_id: 'uuid',
        progress: 75,           // ì§„í–‰ë¥  (0-100)
        current_step: 4,        // í˜„ì¬ ë‹¨ê³„
        elapsed_time: 12500     // ê²½ê³¼ ì‹œê°„ (ms)
    },

    game_finish: {
        user_id: 'uuid',
        final_time: 15230,      // ìµœì¢… ì‹œê°„
        rank: 1                 // ìˆœìœ„
    }
};
```

### 3.4 ê²Œì„ ë£¸ ê´€ë¦¬ í´ë˜ìŠ¤

```javascript
// js/game-room.js

class GameRoom {
    constructor() {
        this.roomId = null;
        this.roomCode = null;
        this.isHost = false;
        this.channel = null;
        this.participants = [];
        this.gameState = 'waiting'; // waiting, ready, playing, finished
    }

    // ==========================================
    // ë°© ìƒì„± (í˜¸ìŠ¤íŠ¸)
    // ==========================================
    async createRoom(gameType, difficulty) {
        const userId = sessionStorage.getItem('userId');
        const nickname = sessionStorage.getItem('nickname');

        if (!userId) {
            throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        }

        // 6ìë¦¬ ë°© ì½”ë“œ ìƒì„±
        this.roomCode = this.generateRoomCode();

        // DBì— ë°© ìƒì„±
        const { data, error } = await supabase
            .from('game_rooms')
            .insert({
                room_code: this.roomCode,
                host_id: userId,
                game_type: gameType,
                difficulty: difficulty,
                status: 'waiting',
                max_players: 2,
                settings: {
                    countdown: 3,
                    allow_spectators: false
                }
            })
            .select()
            .single();

        if (error) throw error;

        this.roomId = data.id;
        this.isHost = true;

        // í˜¸ìŠ¤íŠ¸ë¥¼ ì°¸ê°€ìë¡œ ì¶”ê°€
        await this.addParticipant(userId, nickname);

        // ì‹¤ì‹œê°„ ì±„ë„ êµ¬ë…
        await this.subscribeToRoom();

        return {
            roomId: this.roomId,
            roomCode: this.roomCode
        };
    }

    // ==========================================
    // ë°© ì°¸ê°€ (ê²ŒìŠ¤íŠ¸)
    // ==========================================
    async joinRoom(roomCode) {
        const userId = sessionStorage.getItem('userId');
        const nickname = sessionStorage.getItem('nickname');

        if (!userId) {
            throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        }

        // ë°© ì°¾ê¸°
        const { data: room, error: findError } = await supabase
            .from('game_rooms')
            .select('*')
            .eq('room_code', roomCode.toUpperCase())
            .eq('status', 'waiting')
            .single();

        if (findError || !room) {
            throw new Error('ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }

        // ì°¸ê°€ì ìˆ˜ í™•ì¸
        const { count } = await supabase
            .from('game_participants')
            .select('*', { count: 'exact' })
            .eq('room_id', room.id);

        if (count >= room.max_players) {
            throw new Error('ë°©ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤.');
        }

        this.roomId = room.id;
        this.roomCode = roomCode;
        this.isHost = false;

        // ì°¸ê°€ìë¡œ ì¶”ê°€
        await this.addParticipant(userId, nickname);

        // ì‹¤ì‹œê°„ ì±„ë„ êµ¬ë…
        await this.subscribeToRoom();

        // ì°¸ê°€ ì•Œë¦¼ ë¸Œë¡œë“œìºìŠ¤íŠ¸
        this.broadcast(GAME_EVENTS.PLAYER_JOIN, {
            user_id: userId,
            nickname: nickname
        });

        return room;
    }

    // ==========================================
    // ì°¸ê°€ì ì¶”ê°€
    // ==========================================
    async addParticipant(userId, nickname) {
        const { error } = await supabase
            .from('game_participants')
            .insert({
                room_id: this.roomId,
                user_id: userId,
                nickname: nickname,
                is_ready: this.isHost, // í˜¸ìŠ¤íŠ¸ëŠ” ìë™ ì¤€ë¹„
                is_host: this.isHost
            });

        if (error) throw error;
    }

    // ==========================================
    // ì‹¤ì‹œê°„ ì±„ë„ êµ¬ë…
    // ==========================================
    async subscribeToRoom() {
        this.channel = supabase
            .channel(`game-room-${this.roomId}`)
            .on('broadcast', { event: '*' }, (payload) => {
                this.handleBroadcast(payload);
            })
            .on('presence', { event: 'sync' }, () => {
                this.handlePresenceSync();
            })
            .on('presence', { event: 'join' }, ({ key, newPresences }) => {
                this.handlePresenceJoin(newPresences);
            })
            .on('presence', { event: 'leave' }, ({ key, leftPresences }) => {
                this.handlePresenceLeave(leftPresences);
            })
            .subscribe(async (status) => {
                if (status === 'SUBSCRIBED') {
                    // Presence íŠ¸ë˜í‚¹ ì‹œì‘
                    await this.channel.track({
                        user_id: sessionStorage.getItem('userId'),
                        nickname: sessionStorage.getItem('nickname'),
                        online_at: new Date().toISOString()
                    });
                }
            });
    }

    // ==========================================
    // ë¸Œë¡œë“œìºìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡
    // ==========================================
    broadcast(event, payload) {
        this.channel.send({
            type: 'broadcast',
            event: event,
            payload: {
                ...payload,
                timestamp: Date.now()
            }
        });
    }

    // ==========================================
    // ë¸Œë¡œë“œìºìŠ¤íŠ¸ ë©”ì‹œì§€ ìˆ˜ì‹  ì²˜ë¦¬
    // ==========================================
    handleBroadcast(payload) {
        const { event, payload: data } = payload;

        switch (event) {
            case GAME_EVENTS.PLAYER_JOIN:
                this.onPlayerJoin(data);
                break;

            case GAME_EVENTS.PLAYER_READY:
                this.onPlayerReady(data);
                break;

            case GAME_EVENTS.GAME_START:
                this.onGameStart(data);
                break;

            case GAME_EVENTS.PROGRESS_UPDATE:
                this.onProgressUpdate(data);
                break;

            case GAME_EVENTS.GAME_FINISH:
                this.onGameFinish(data);
                break;

            case GAME_EVENTS.CHAT_MESSAGE:
                this.onChatMessage(data);
                break;

            case GAME_EVENTS.COUNTDOWN:
                this.onCountdown(data);
                break;
        }
    }

    // ==========================================
    // ì¤€ë¹„ ì™„ë£Œ
    // ==========================================
    async setReady(isReady) {
        const userId = sessionStorage.getItem('userId');

        await supabase
            .from('game_participants')
            .update({ is_ready: isReady })
            .eq('room_id', this.roomId)
            .eq('user_id', userId);

        this.broadcast(GAME_EVENTS.PLAYER_READY, {
            user_id: userId,
            is_ready: isReady
        });
    }

    // ==========================================
    // ê²Œì„ ì‹œì‘ (í˜¸ìŠ¤íŠ¸ë§Œ)
    // ==========================================
    async startGame() {
        if (!this.isHost) {
            throw new Error('í˜¸ìŠ¤íŠ¸ë§Œ ê²Œì„ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        }

        // ëª¨ë“  ì°¸ê°€ì ì¤€ë¹„ í™•ì¸
        const { data: participants } = await supabase
            .from('game_participants')
            .select('is_ready')
            .eq('room_id', this.roomId);

        const allReady = participants.every(p => p.is_ready);

        if (!allReady) {
            throw new Error('ëª¨ë“  í”Œë ˆì´ì–´ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        }

        // ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘
        for (let i = 3; i > 0; i--) {
            this.broadcast(GAME_EVENTS.COUNTDOWN, { count: i });
            await this.delay(1000);
        }

        // ê²Œì„ ìƒíƒœ ì—…ë°ì´íŠ¸
        await supabase
            .from('game_rooms')
            .update({
                status: 'playing',
                started_at: new Date().toISOString()
            })
            .eq('id', this.roomId);

        // ê²Œì„ ì‹œì‘ ë¸Œë¡œë“œìºìŠ¤íŠ¸
        this.broadcast(GAME_EVENTS.GAME_START, {
            start_time: Date.now()
        });

        this.gameState = 'playing';
    }

    // ==========================================
    // ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
    // ==========================================
    updateProgress(progress, currentStep, elapsedTime) {
        this.broadcast(GAME_EVENTS.PROGRESS_UPDATE, {
            user_id: sessionStorage.getItem('userId'),
            progress: progress,
            current_step: currentStep,
            elapsed_time: elapsedTime
        });
    }

    // ==========================================
    // ê²Œì„ ì™„ë£Œ
    // ==========================================
    async finishGame(finalTime) {
        const userId = sessionStorage.getItem('userId');

        // ì°¸ê°€ì ê¸°ë¡ ì—…ë°ì´íŠ¸
        await supabase
            .from('game_participants')
            .update({
                finish_time: finalTime,
                finished_at: new Date().toISOString()
            })
            .eq('room_id', this.roomId)
            .eq('user_id', userId);

        // ì™„ë£Œ ë¸Œë¡œë“œìºìŠ¤íŠ¸
        this.broadcast(GAME_EVENTS.GAME_FINISH, {
            user_id: userId,
            final_time: finalTime
        });
    }

    // ==========================================
    // ë°© ë‚˜ê°€ê¸°
    // ==========================================
    async leaveRoom() {
        const userId = sessionStorage.getItem('userId');

        // ì°¸ê°€ì ì œê±°
        await supabase
            .from('game_participants')
            .delete()
            .eq('room_id', this.roomId)
            .eq('user_id', userId);

        // í‡´ì¥ ì•Œë¦¼
        this.broadcast(GAME_EVENTS.PLAYER_LEAVE, {
            user_id: userId
        });

        // í˜¸ìŠ¤íŠ¸ê°€ ë‚˜ê°€ë©´ ë°© ë‹«ê¸°
        if (this.isHost) {
            await supabase
                .from('game_rooms')
                .update({ status: 'closed' })
                .eq('id', this.roomId);
        }

        // ì±„ë„ êµ¬ë… í•´ì œ
        if (this.channel) {
            await supabase.removeChannel(this.channel);
        }
    }

    // ==========================================
    // ìœ í‹¸ë¦¬í‹°
    // ==========================================
    generateRoomCode() {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
        let code = '';
        for (let i = 0; i < 6; i++) {
            code += chars[Math.floor(Math.random() * chars.length)];
        }
        return code;
    }

    delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    // ì´ë²¤íŠ¸ ì½œë°± (ì˜¤ë²„ë¼ì´ë“œ)
    onPlayerJoin(data) {}
    onPlayerReady(data) {}
    onGameStart(data) {}
    onProgressUpdate(data) {}
    onGameFinish(data) {}
    onChatMessage(data) {}
    onCountdown(data) {}
    handlePresenceSync() {}
    handlePresenceJoin(presences) {}
    handlePresenceLeave(presences) {}
}
```

### 3.5 ì¹œêµ¬ ëŒ€ê²° UI

```html
<!-- ëŒ€ê²° ë¡œë¹„ í™”ë©´ -->
<div class="lobby-container">
    <!-- ë°© ìƒì„±/ì°¸ê°€ ì„ íƒ -->
    <div class="lobby-options" id="lobbyOptions">
        <h2>ì¹œêµ¬ ëŒ€ê²° ëª¨ë“œ</h2>

        <div class="option-cards">
            <div class="option-card" onclick="showCreateRoom()">
                <div class="option-icon">ğŸ </div>
                <h3>ë°© ë§Œë“¤ê¸°</h3>
                <p>ì¹œêµ¬ë¥¼ ì´ˆëŒ€í•  ë°©ì„ ìƒì„±í•©ë‹ˆë‹¤</p>
            </div>

            <div class="option-card" onclick="showJoinRoom()">
                <div class="option-icon">ğŸšª</div>
                <h3>ë°© ì°¸ê°€í•˜ê¸°</h3>
                <p>ì´ˆëŒ€ ì½”ë“œë¡œ ë°©ì— ì°¸ê°€í•©ë‹ˆë‹¤</p>
            </div>
        </div>
    </div>

    <!-- ë°© ìƒì„± í™”ë©´ -->
    <div class="create-room" id="createRoom" style="display: none;">
        <h2>ë°© ë§Œë“¤ê¸°</h2>

        <div class="form-group">
            <label>ê²Œì„ ì¢…ë¥˜</label>
            <select id="gameType">
                <option value="concert">ì½˜ì„œíŠ¸</option>
                <option value="goods">êµ¿ì¦ˆ</option>
                <option value="restaurant">ì‹ë‹¹</option>
            </select>
        </div>

        <div class="form-group">
            <label>ë‚œì´ë„</label>
            <select id="difficulty">
                <option value="easy">ì‰¬ì›€</option>
                <option value="normal">ë³´í†µ</option>
                <option value="hard">ì–´ë ¤ì›€</option>
            </select>
        </div>

        <button class="btn-primary" onclick="createRoom()">ë°© ìƒì„±</button>
        <button class="btn-secondary" onclick="backToOptions()">ì·¨ì†Œ</button>
    </div>

    <!-- ë°© ì°¸ê°€ í™”ë©´ -->
    <div class="join-room" id="joinRoom" style="display: none;">
        <h2>ë°© ì°¸ê°€í•˜ê¸°</h2>

        <div class="form-group">
            <label>ì´ˆëŒ€ ì½”ë“œ</label>
            <input type="text" id="roomCode" placeholder="6ìë¦¬ ì½”ë“œ ì…ë ¥"
                   maxlength="6" style="text-transform: uppercase;">
        </div>

        <button class="btn-primary" onclick="joinRoom()">ì°¸ê°€</button>
        <button class="btn-secondary" onclick="backToOptions()">ì·¨ì†Œ</button>
    </div>

    <!-- ëŒ€ê¸°ì‹¤ -->
    <div class="waiting-room" id="waitingRoom" style="display: none;">
        <div class="room-info">
            <h2>ëŒ€ê¸°ì‹¤</h2>
            <div class="room-code-display">
                <span>ì´ˆëŒ€ ì½”ë“œ</span>
                <strong id="displayRoomCode">ABC123</strong>
                <button onclick="copyRoomCode()">ğŸ“‹ ë³µì‚¬</button>
            </div>
        </div>

        <div class="players-list" id="playersList">
            <!-- ë™ì ìœ¼ë¡œ í”Œë ˆì´ì–´ ì¹´ë“œ ì¶”ê°€ -->
        </div>

        <div class="waiting-actions">
            <button class="btn-ready" id="readyBtn" onclick="toggleReady()">
                ì¤€ë¹„ ì™„ë£Œ
            </button>
            <button class="btn-start" id="startBtn" onclick="startGame()"
                    style="display: none;">
                ê²Œì„ ì‹œì‘
            </button>
            <button class="btn-leave" onclick="leaveRoom()">ë‚˜ê°€ê¸°</button>
        </div>

        <!-- ì±„íŒ… -->
        <div class="lobby-chat">
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input">
                <input type="text" id="chatInput" placeholder="ë©”ì‹œì§€ ì…ë ¥..."
                       onkeypress="handleChatKeypress(event)">
                <button onclick="sendChat()">ì „ì†¡</button>
            </div>
        </div>
    </div>
</div>
```

### 3.6 ì¹œêµ¬ ëŒ€ê²° ìŠ¤íƒ€ì¼

```css
/* css/friend-battle.css */

.lobby-container {
    max-width: 600px;
    margin: 0 auto;
    padding: 20px;
}

.option-cards {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 30px;
}

.option-card {
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 30px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.option-card:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: #3b82f6;
    transform: translateY(-5px);
}

.option-icon {
    font-size: 3rem;
    margin-bottom: 15px;
}

.room-code-display {
    display: flex;
    align-items: center;
    gap: 15px;
    background: rgba(59, 130, 246, 0.2);
    padding: 15px 20px;
    border-radius: 12px;
    margin: 20px 0;
}

.room-code-display strong {
    font-size: 1.5rem;
    font-family: 'Courier New', monospace;
    letter-spacing: 4px;
    color: #60a5fa;
}

.players-list {
    display: flex;
    justify-content: center;
    gap: 30px;
    margin: 30px 0;
}

.player-slot {
    width: 150px;
    height: 180px;
    background: rgba(255, 255, 255, 0.05);
    border: 2px dashed rgba(255, 255, 255, 0.2);
    border-radius: 16px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.player-slot.occupied {
    border-style: solid;
    border-color: rgba(59, 130, 246, 0.5);
}

.player-slot.ready {
    border-color: #22c55e;
    background: rgba(34, 197, 94, 0.1);
}

.player-slot .avatar {
    font-size: 3rem;
    margin-bottom: 10px;
}

.player-slot .nickname {
    font-weight: bold;
    color: #fff;
}

.player-slot .status {
    font-size: 0.9rem;
    margin-top: 8px;
}

.player-slot .status.ready {
    color: #22c55e;
}

.player-slot .status.waiting {
    color: #f59e0b;
}

.waiting-actions {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin: 20px 0;
}

.btn-ready {
    padding: 12px 30px;
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border: none;
    border-radius: 8px;
    color: white;
    font-weight: bold;
    cursor: pointer;
}

.btn-ready.not-ready {
    background: linear-gradient(135deg, #6b7280, #4b5563);
}

.btn-start {
    padding: 12px 30px;
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    border: none;
    border-radius: 8px;
    color: white;
    font-weight: bold;
    cursor: pointer;
}

.btn-start:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.lobby-chat {
    margin-top: 30px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    overflow: hidden;
}

.chat-messages {
    height: 150px;
    padding: 15px;
    overflow-y: auto;
}

.chat-input {
    display: flex;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.chat-input input {
    flex: 1;
    padding: 12px 15px;
    background: transparent;
    border: none;
    color: #fff;
}

.chat-input button {
    padding: 12px 20px;
    background: #3b82f6;
    border: none;
    color: white;
    cursor: pointer;
}

/* ì¹´ìš´íŠ¸ë‹¤ìš´ ì˜¤ë²„ë ˆì´ */
.countdown-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.countdown-number {
    font-size: 10rem;
    font-weight: bold;
    color: #fff;
    animation: countdown-pulse 1s ease-in-out;
}

@keyframes countdown-pulse {
    0% { transform: scale(0.5); opacity: 0; }
    50% { transform: scale(1.2); opacity: 1; }
    100% { transform: scale(1); opacity: 1; }
}
```

---

## 4. ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

### 4.1 ê²Œì„ ë£¸ í…Œì´ë¸”

```sql
-- ê²Œì„ ë°© í…Œì´ë¸”
CREATE TABLE game_rooms (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    room_code VARCHAR(6) UNIQUE NOT NULL,
    host_id UUID REFERENCES users(id) NOT NULL,
    game_type VARCHAR(20) NOT NULL,  -- 'concert', 'goods', 'restaurant'
    difficulty VARCHAR(10) NOT NULL,  -- 'easy', 'normal', 'hard'
    status VARCHAR(20) DEFAULT 'waiting',  -- 'waiting', 'playing', 'finished', 'closed'
    max_players INTEGER DEFAULT 2,
    settings JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    started_at TIMESTAMPTZ,
    finished_at TIMESTAMPTZ
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_game_rooms_code ON game_rooms(room_code);
CREATE INDEX idx_game_rooms_status ON game_rooms(status);
CREATE INDEX idx_game_rooms_host ON game_rooms(host_id);
```

### 4.2 ê²Œì„ ì°¸ê°€ì í…Œì´ë¸”

```sql
-- ê²Œì„ ì°¸ê°€ì í…Œì´ë¸”
CREATE TABLE game_participants (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    room_id UUID REFERENCES game_rooms(id) ON DELETE CASCADE,
    user_id UUID REFERENCES users(id),
    nickname VARCHAR(50) NOT NULL,
    is_host BOOLEAN DEFAULT FALSE,
    is_ready BOOLEAN DEFAULT FALSE,
    progress INTEGER DEFAULT 0,  -- ì§„í–‰ë¥  (0-100)
    finish_time INTEGER,  -- ì™„ë£Œ ì‹œê°„ (ms)
    rank INTEGER,  -- ìµœì¢… ìˆœìœ„
    joined_at TIMESTAMPTZ DEFAULT NOW(),
    finished_at TIMESTAMPTZ,

    UNIQUE(room_id, user_id)
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_participants_room ON game_participants(room_id);
CREATE INDEX idx_participants_user ON game_participants(user_id);
```

### 4.3 ëŒ€ê²° ê¸°ë¡ í…Œì´ë¸”

```sql
-- ëŒ€ê²° ê¸°ë¡ í…Œì´ë¸” (í†µê³„ìš©)
CREATE TABLE battle_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    room_id UUID REFERENCES game_rooms(id),
    winner_id UUID REFERENCES users(id),
    loser_id UUID REFERENCES users(id),
    game_type VARCHAR(20),
    difficulty VARCHAR(10),
    winner_time INTEGER,  -- ìŠ¹ì ì‹œê°„ (ms)
    loser_time INTEGER,   -- íŒ¨ì ì‹œê°„ (ms)
    time_diff INTEGER,    -- ì‹œê°„ ì°¨ì´ (ms)
    battle_type VARCHAR(20),  -- 'ai', 'friend'
    ai_profile VARCHAR(20),   -- AI ëŒ€ê²°ì¸ ê²½ìš° í”„ë¡œí•„
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_battle_winner ON battle_records(winner_id);
CREATE INDEX idx_battle_loser ON battle_records(loser_id);
CREATE INDEX idx_battle_type ON battle_records(battle_type);
```

### 4.4 RLS ì •ì±…

```sql
-- game_rooms RLS
ALTER TABLE game_rooms ENABLE ROW LEVEL SECURITY;

CREATE POLICY "ë°© ì¡°íšŒëŠ” ëª¨ë‘ ê°€ëŠ¥" ON game_rooms
    FOR SELECT USING (true);

CREATE POLICY "ë°© ìƒì„±ì€ ë¡œê·¸ì¸ ì‚¬ìš©ìë§Œ" ON game_rooms
    FOR INSERT WITH CHECK (auth.uid() IS NOT NULL);

CREATE POLICY "ë°© ìˆ˜ì •ì€ í˜¸ìŠ¤íŠ¸ë§Œ" ON game_rooms
    FOR UPDATE USING (host_id = auth.uid());

-- game_participants RLS
ALTER TABLE game_participants ENABLE ROW LEVEL SECURITY;

CREATE POLICY "ì°¸ê°€ì ì¡°íšŒëŠ” ê°™ì€ ë°© ì‚¬ìš©ìë§Œ" ON game_participants
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM game_participants p
            WHERE p.room_id = game_participants.room_id
            AND p.user_id = auth.uid()
        )
    );

CREATE POLICY "ì°¸ê°€ëŠ” ë¡œê·¸ì¸ ì‚¬ìš©ìë§Œ" ON game_participants
    FOR INSERT WITH CHECK (user_id = auth.uid());

CREATE POLICY "ìì‹ ì˜ ì •ë³´ë§Œ ìˆ˜ì •" ON game_participants
    FOR UPDATE USING (user_id = auth.uid());
```

### 4.5 Supabase Realtime ì„¤ì •

```sql
-- Realtime í™œì„±í™”
ALTER PUBLICATION supabase_realtime ADD TABLE game_rooms;
ALTER PUBLICATION supabase_realtime ADD TABLE game_participants;

-- Broadcast ì„¤ì • (Supabase Dashboardì—ì„œ)
-- 1. Database â†’ Replication â†’ supabase_realtime í™•ì¸
-- 2. game_rooms, game_participants í…Œì´ë¸” ì²´í¬
```

---

## 5. êµ¬í˜„ ìš°ì„ ìˆœìœ„

### 5.1 Phase 1: ê°€ìƒ ê²½ìŸì AI (1-2ì¼)

| ìˆœì„œ | ì‘ì—… | ì˜ˆìƒ ì‹œê°„ |
|------|------|----------|
| 1 | AI í”„ë¡œí•„ ì •ì˜ (ai-profiles.js) | 2ì‹œê°„ |
| 2 | AI ì‹œë®¬ë ˆì´í„° êµ¬í˜„ (ai-simulator.js) | 3ì‹œê°„ |
| 3 | ëŒ€ê²° UI êµ¬í˜„ (battle.html, battle.css) | 4ì‹œê°„ |
| 4 | ëŒ€ê²° ê´€ë¦¬ì êµ¬í˜„ (battle-manager.js) | 4ì‹œê°„ |
| 5 | ê¸°ì¡´ ê²Œì„ê³¼ í†µí•© | 3ì‹œê°„ |
| 6 | í…ŒìŠ¤íŠ¸ ë° ë°¸ëŸ°ì‹± | 2ì‹œê°„ |

### 5.2 Phase 2: ì¹œêµ¬ ëŒ€ê²° ëª¨ë“œ (3-5ì¼)

| ìˆœì„œ | ì‘ì—… | ì˜ˆìƒ ì‹œê°„ |
|------|------|----------|
| 1 | DB í…Œì´ë¸” ìƒì„± ë° RLS ì„¤ì • | 2ì‹œê°„ |
| 2 | Supabase Realtime ì„¤ì • | 1ì‹œê°„ |
| 3 | ê²Œì„ ë£¸ í´ë˜ìŠ¤ êµ¬í˜„ (game-room.js) | 6ì‹œê°„ |
| 4 | ë¡œë¹„ UI êµ¬í˜„ (friend-battle.html) | 4ì‹œê°„ |
| 5 | ëŒ€ê¸°ì‹¤ UI êµ¬í˜„ | 3ì‹œê°„ |
| 6 | ì‹¤ì‹œê°„ ëŒ€ê²° í™”ë©´ êµ¬í˜„ | 4ì‹œê°„ |
| 7 | ì±„íŒ… ê¸°ëŠ¥ êµ¬í˜„ | 2ì‹œê°„ |
| 8 | ê²°ê³¼ í™”ë©´ ë° ê¸°ë¡ ì €ì¥ | 3ì‹œê°„ |
| 9 | í…ŒìŠ¤íŠ¸ ë° ë²„ê·¸ ìˆ˜ì • | 4ì‹œê°„ |

### 5.3 Phase 3: ê³ ê¸‰ ê¸°ëŠ¥ (ì„ íƒ)

- [ ] ê´€ì „ ëª¨ë“œ
- [ ] í† ë„ˆë¨¼íŠ¸ ëª¨ë“œ (4ì¸ ì´ìƒ)
- [ ] AI ëŒ€ê²° ê¸°ë¡ ë­í‚¹
- [ ] ì¹œêµ¬ ëª©ë¡ ë° ì´ˆëŒ€ ê¸°ëŠ¥
- [ ] ëŒ€ê²° ë¦¬í”Œë ˆì´ ê¸°ëŠ¥

---

## ë¶€ë¡: íŒŒì¼ êµ¬ì¡°

```
c/test_ticket/
â”œâ”€â”€ js/
â”‚   â”œâ”€â”€ ai-profiles.js          # AI í”„ë¡œí•„ ì •ì˜
â”‚   â”œâ”€â”€ ai-simulator.js         # AI ì‹œë®¬ë ˆì´ì…˜ ì—”ì§„
â”‚   â”œâ”€â”€ battle-manager.js       # ê°€ìƒ ëŒ€ê²° ê´€ë¦¬ì
â”‚   â”œâ”€â”€ game-room.js            # ì¹œêµ¬ ëŒ€ê²° ë£¸ ê´€ë¦¬
â”‚   â””â”€â”€ supabase-config.js      # (ê¸°ì¡´ íŒŒì¼ - Realtime í•¨ìˆ˜ ì¶”ê°€)
â”œâ”€â”€ css/
â”‚   â”œâ”€â”€ battle.css              # ëŒ€ê²° í™”ë©´ ìŠ¤íƒ€ì¼
â”‚   â””â”€â”€ friend-battle.css       # ì¹œêµ¬ ëŒ€ê²° ìŠ¤íƒ€ì¼
â”œâ”€â”€ main-pages/
â”‚   â”œâ”€â”€ battle-ai.html          # ê°€ìƒ AI ëŒ€ê²° í˜ì´ì§€
â”‚   â””â”€â”€ battle-friend.html      # ì¹œêµ¬ ëŒ€ê²° í˜ì´ì§€
â””â”€â”€ index.html                   # (ìˆ˜ì • - ëŒ€ê²° ëª¨ë“œ ë©”ë‰´ ì¶”ê°€)
```

---

*ë¬¸ì„œ ì‘ì„±ì¼: 2025-12-10*
*ë²„ì „: 1.0*
